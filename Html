using System;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using Telerik.Windows.Documents.Flow.Model;
using Telerik.Windows.Documents.Fixed.Model;
using Telerik.Windows.Documents.Fixed.FormatProviders.Pdf;
using Telerik.Windows.Documents.Fixed.Model.Editing;
using Telerik.Windows.Documents.Fixed.Model.Styles;
using Telerik.Windows.Documents.Common.FormatProviders;

public class ReportController : Controller
{
    private readonly IReportComponent _reportComponent;
    private readonly IUserContext _userContext;

    public ReportController(IReportComponent reportComponent, IUserContext userContext)
    {
        _reportComponent = reportComponent;
        _userContext = userContext;
    }

    [HttpGet("export-adhoc-report")]
    public async Task<IActionResult> ExportAdhocReport(Guid reportId)
    {
        // Fetch the report data
        var saveResponse = await _reportComponent.GetAdhocReportDatatable(reportId, _userContext.EmployeeId);

        if (saveResponse == null || !saveResponse.Any())
        {
            return Content("No data available");
        }

        // Convert data to HTML dynamically (simple version)
        var sb = new StringBuilder();
        sb.Append("<html><head><title>AdHoc Report</title>");
        sb.Append("<style>table {width: 100%; border-collapse: collapse;} th, td {padding: 8px; text-align: left; border: 1px solid black;} th {background-color: #f2f2f2;}</style>");
        sb.Append("</head><body>");
        sb.Append("<h2>AdHoc Report</h2><table>");

        var firstRow = saveResponse.First();
        var columnNames = ((IDictionary<string, object>)firstRow).Keys;

        sb.Append("<tr>");
        foreach (var column in columnNames)
        {
            sb.Append($"<th>{column}</th>");
        }
        sb.Append("</tr>");

        foreach (var row in saveResponse)
        {
            sb.Append("<tr>");
            foreach (var column in columnNames)
            {
                sb.Append($"<td>{((IDictionary<string, object>)row)[column]}</td>");
            }
            sb.Append("</tr>");
        }

        sb.Append("</table></body></html>");

        // Use RadPdfProcessing to create a PDF document
        RadFixedDocument document = new RadFixedDocument();
        RadFixedPage page = document.Pages.AddPage();
        RadFixedPageEditor editor = new RadFixedPageEditor(page);

        // Set page style
        editor.SetStyle(new Style()
        {
            FontSize = 10
        });

        // Add a title
        editor.InsertText("AdHoc Report", 10, 10);

        // Insert table from the HTML content dynamically
        float currentYPosition = 40;
        editor.InsertText("Columns:", 10, currentYPosition);
        currentYPosition += 20;

        // Define table header
        var headerCells = columnNames.ToList();
        editor.InsertText(string.Join(" | ", headerCells), 10, currentYPosition);
        currentYPosition += 20;

        // Define table rows
        foreach (var row in saveResponse)
        {
            var rowValues = columnNames.Select(col => ((IDictionary<string, object>)row)[col].ToString()).ToList();
            editor.InsertText(string.Join(" | ", rowValues), 10, currentYPosition);
            currentYPosition += 20;
        }

        // Create the PDF output stream
        PdfFormatProvider pdfProvider = new PdfFormatProvider();
        using (MemoryStream stream = new MemoryStream())
        {
            pdfProvider.Export(document, stream);
            string fileName = $"AdHocReport_{DateTime.Now:yyyy-MM-dd_HH-mm-ss-fff}.pdf";
            return File(stream.ToArray(), "application/pdf", fileName);
        }
    }
}
